
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Docker Is Awesome - Part I - Pritish Chakraborty</title>
  <meta name="author" content="Pritish Chakraborty">

  
  <meta name="description" content="It&rsquo;s been a while since I&rsquo;ve written a blog post. There&rsquo;s been lots of changes that I&rsquo;ve
had to deal with, the big one being &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://PritishC.github.io/blog/2015/09/03/docker-is-awesome">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Pritish Chakraborty" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-56615772-1']);
    _gaq.push(['_setDomainName', 'pritishc.com']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><div class="header-left">
  <hgroup>
  <h1><a href="/">Pritish Chakraborty</a></h1>
  
  <div class="subtitle">
    <h2>Work and Everything Else</h2>
  </div>
  
  </hgroup>
  
</div>

<div class="header-right">
  <ul class="main-navigation">
 <div> 
  <li><a href="/">blog</a></li></div><div class="spacer"></div>
     <div> 
  <li><a href="/projects">projects</a></li></div><div class="spacer"></div>
       <div> 
  <li><a href="/work">work</a></li></div><div class="spacer"></div>
         <div> 
  <li><a href="/about">about</a></li></div>
</ul>
  

</div>
</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Docker Is Awesome - Part I</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-03T21:56:16+05:30" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>It&rsquo;s been a while since I&rsquo;ve written a blog post. There&rsquo;s been lots of changes that I&rsquo;ve
had to deal with, the big one being a change of workplace. And I realize that this post
should&rsquo;ve been the one explaining my adventures with Elasticsearch. That will have to wait
for a bit, my apologies!</p>

<p>In this article, I&rsquo;m going to explain my (possibly flawed) method of deploying a Django/Angular
app using Docker. I&rsquo;ve wanted to learn how to deploy an app to AWS for a while, and Docker
helped me do just that.</p>

<!--more-->


<p>I assume that the reader has a basic knowledge of the docker toolbox; if not, I&rsquo;ll explain them in brief in
part 2. To begin with, here&rsquo;s the directory structure of my app for reference (generated using the
lovely <code>tree</code> command on Linux) -:</p>

<figure class='code'><figcaption><span>app structure</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">|</span>-- bower.json
</span><span class='line'><span class="p">|</span>-- CONTRIBUTORS
</span><span class='line'><span class="p">|</span>-- project
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- project
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- aws_settings.py <span class="o">(</span>django-storages credentials here<span class="o">)</span>
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- heroku_settings.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- __init__.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- settings.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- urls.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- views.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- wsgi.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- manage.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- app1
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- __init__.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- permissions.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- serializers.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- services.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- tests.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- views.py
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- users
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- __init__.py
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- models.py
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- permissions.py
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- serializers.py
</span><span class='line'><span class="p">|</span>       <span class="sb">`</span>-- views.py
</span><span class='line'><span class="p">|</span>-- gulpfile.js
</span><span class='line'><span class="p">|</span>-- package.json
</span><span class='line'><span class="p">|</span>-- Procfile
</span><span class='line'><span class="p">|</span>-- README.md
</span><span class='line'><span class="p">|</span>-- requirements.txt
</span><span class='line'><span class="p">|</span>-- scripts
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- postInstall.sh
</span><span class='line'><span class="p">|</span>-- static
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- javascripts
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- app.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- controllers
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- controllers.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- directives
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- directives.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- services
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>       <span class="sb">`</span>-- services.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- partials <span class="o">(</span>angular view stuff<span class="o">)</span>
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- stylesheets
</span><span class='line'><span class="p">|</span>       <span class="sb">`</span>-- styles.css
</span><span class='line'><span class="p">|</span>-- templates
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- index.html
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- javascripts.html
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- navbar.html
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- stylesheets.html
</span></code></pre></td></tr></table></div></figure>


<p>This follows from the nice boilerplate provided by <a href="https://github.com/brwr/thinkster-django-angular-boilerplate">thinkster.io</a> - take a look at their nifty tutorials <a href="http://thinkster.io">here</a>.</p>

<p>I first stumbled across this article on <a href="https://realpython.com/blog/python/django-development-with-docker-compose-and-machine/">realpython.com</a>, which greatly piqued my interest. I realized that docker had
moved on to becoming a suite of tools - docker itself becoming docker-engine in name. However,
I faced issues (being a total n00b in devops) in setting up with the configuration that they
specified, so I decided to go for something simpler. I found just what I needed in <a href="https://github.com/andrecp/django-tutorial-docker-nginx-postgres">Andre&rsquo;s</a>
tutorial for deploying a simple Docker-Nginx-Django-Postgres setup.</p>

<p>One thing I noticed in both configurations is that the code repository was bundled alongwith the docker
stuff (needed by docker-compose) for production.
I couldn&rsquo;t agree with that, so I decided to look up a method to clone my repository while creating
the docker container. I then kept my code and deployment repositories separate, and found that Bitbucket
(where my repositories are hosted) have a feature called deployment keys - SSH keys that have read-only
access to a repository. This was exactly what I needed.</p>

<p>Here is the directory structure of my docker deployment repository -:</p>

<figure class='code'><figcaption><span>docker directories</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">|</span>-- docker-compose.yml
</span><span class='line'><span class="p">|</span>-- Dockerfile
</span><span class='line'><span class="p">|</span>-- ec2box.sh
</span><span class='line'><span class="p">|</span>-- nginx
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- container_ip.sh
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- Dockerfile
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- nginx.conf
</span><span class='line'><span class="p">|</span>-- README.md
</span><span class='line'><span class="p">|</span>-- rebuild_docker.sh
</span><span class='line'><span class="p">|</span>-- ssh
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- bb_deploy.rsa
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- bb_deploy.rsa.pub
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- config
</span><span class='line'><span class="sb">`</span>-- static
</span><span class='line'>    <span class="sb">`</span>-- admin
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>docker-compose.yml : The file that controls how docker-compose builds docker containers and runs them</li>
<li>Dockerfile : The Dockerfile for the django/angular container</li>
<li>ec2box.sh : A small script containing a single command which creates the whole setup using AWS drivers</li>
<li>nginx - Directory containing specifics for the nginx container, where container_ip.sh is another
small script which I needed when deploying on AWS</li>
<li>rebuild_docker.sh : A script from Andre&rsquo;s repository for quickly build-and-up containers using docker-compose</li>
<li>ssh : Directory containing my Bitbucket deployment key and a SSH config file</li>
<li>static : Django admin static files</li>
</ul>


<p>The contents of docker-compose.yml are as follows -:</p>

<figure class='code'><figcaption><span>docker-compose.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># Nginx</span>
</span><span class='line'><span class="l-Scalar-Plain">nginx</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./nginx</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes_from</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">django</span>
</span><span class='line'>    <span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">django</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;80:80&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This defines a service for the Django app</span>
</span><span class='line'><span class="c1"># Will include the Angular frontend</span>
</span><span class='line'><span class="l-Scalar-Plain">django</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">.</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">.:/root</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/usr/src/app</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expose</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;8000&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">postgres</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This defines a service for the Postgres database</span>
</span><span class='line'><span class="l-Scalar-Plain">postgres</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres:latest</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note how the nginx container definition specifies a <code>volumes_from</code> section, of which the django
container is a part. The host port 80 has been mapped to container port 80, as nginx requires.
One little caveat: make sure that no other docker containers are hogging up port 80, because you
will have a painful time trying to find out why your nginx container keeps dying on you. The <code>links</code>
directive creates entries in the nginx container&rsquo;s <code>/etc/hosts</code> file for the django container&rsquo;s IP/hostname.
This will come in use later when we deploy to AWS.</p>

<p>The django container definition has a few small differences from the one mentioned at realpython or
Andre&rsquo;s tutorial. We mount the volume on <code>/root</code> instead of <code>/usr/src/app</code>, because the latter does
not exist until we clone the code repository. Additionally, we expose <code>/usr/src/app</code> as a volume, so
that the nginx container does not run into a load of 404s when trying to serve static files. Port 8000
is exposed as we shall be running gunicorn on that port, and there is a link to the postgres container.</p>

<p>The postgres definition is not much to talk about, as it is built from an image from the docker registry
(yes, they have a registry of known docker containers!).</p>

<p>Let&rsquo;s take a look at the Dockerfile for the django container -:</p>

<figure class='code'><figcaption><span>Dockerfile (django)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM ubuntu:14.04
</span><span class='line'>
</span><span class='line'>ENV DJANGO_CONFIGURATION Docker
</span><span class='line'>
</span><span class='line'><span class="c"># First, we need to get git, and clone our repository</span>
</span><span class='line'><span class="c"># Additionally, get everything else here too, such as nodejs and npm</span>
</span><span class='line'>
</span><span class='line'>RUN apt-get update
</span><span class='line'>RUN apt-get install -y ca-certificates git-core ssh nodejs npm python-pip libpq-dev python-dev
</span><span class='line'>RUN ln -s /usr/bin/nodejs /usr/bin/node
</span><span class='line'>
</span><span class='line'>ENV HOME /root
</span><span class='line'>
</span><span class='line'><span class="c"># Add custom ssh keypair - usually Bitbucket deployment keys</span>
</span><span class='line'>ADD ssh/ /root/.ssh/
</span><span class='line'>
</span><span class='line'><span class="c"># Fix permissions</span>
</span><span class='line'>RUN chmod <span class="m">600</span> /root/.ssh/*
</span><span class='line'>
</span><span class='line'><span class="c"># Avoid first connection host confirmation</span>
</span><span class='line'>RUN ssh-keyscan bitbucket.org &gt; /root/.ssh/known_hosts
</span><span class='line'>
</span><span class='line'><span class="c"># Clone the repo</span>
</span><span class='line'>WORKDIR /usr/src/app
</span><span class='line'>RUN git clone git@bitbucket.org:username/repo
</span><span class='line'>
</span><span class='line'><span class="c"># Install requirements</span>
</span><span class='line'>WORKDIR /usr/src/app/repo
</span><span class='line'>RUN pip install -r requirements.txt
</span><span class='line'>RUN npm install -g bower
</span><span class='line'>RUN bower --allow-root install
</span><span class='line'>
</span><span class='line'><span class="c"># S3 Storage for django-storages</span>
</span><span class='line'>ENV AWS_ACCESS_KEY yourkeyhere
</span><span class='line'>ENV AWS_SECRET_ACCESS_KEY yoursecretsaucehere
</span><span class='line'>ENV S3_BUCKET_NAME yourbucketnamehere
</span><span class='line'>
</span><span class='line'><span class="c"># DB Settings</span>
</span><span class='line'>ENV DB_NAME postgres
</span><span class='line'>ENV DB_USER postgres
</span><span class='line'>ENV DB_PASS postgres
</span><span class='line'>ENV DB_SERVICE postgres
</span><span class='line'>
</span><span class='line'><span class="c"># Add Django Admin CSS</span>
</span><span class='line'>ADD ./static/admin /usr/src/app/repo/static/admin
</span><span class='line'>
</span><span class='line'>WORKDIR /usr/src/app/repo/defsec
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;gunicorn&quot;</span>, <span class="s2">&quot;app.wsgi&quot;</span>, <span class="s2">&quot;-w&quot;</span>, <span class="s2">&quot;2&quot;</span>, <span class="s2">&quot;-b&quot;</span>, <span class="s2">&quot;0.0.0.0:8000&quot;</span>, <span class="s2">&quot;--log-level&quot;</span>, <span class="s2">&quot;-&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>DJANGO_CONFIGURATION</code> environment variable is used in django project settings. First, we
install all the necessary command line tools, and create a symbolic link so that nodejs plays
well. We then add our custom keypair to the <code>.ssh</code> directory, and run a permissions fix command.
This will allow us to clone the code repository. Before running the clone command, we run a
<code>ssh-keyscan</code> so that the cloning process is automatic - no key passphrase prompts. Some may argue
that this lowers security, but that is a topic for another post altogether.
After cloning, I install all django/angular requirements using pip and bower. A few more environment
variables are then set, first for django-storages (a topic for a soon-to-come post: how I set up
image uploads to Amazon S3 with django-storages) and then for the postgres database. Finally,
django admin static files are added (yes, these don&rsquo;t come out of nowhere, they need to be added
for nginx to serve them) and run the gunicorn server.</p>

<p>With that covered, let&rsquo;s check out the contents of the nginx directory. First up is the nginx
Dockerfile -:</p>

<figure class='code'><figcaption><span>nginx Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Set nginx base image</span>
</span><span class='line'>FROM nginx
</span><span class='line'>
</span><span class='line'><span class="c"># File Author / Maintainer</span>
</span><span class='line'>MAINTAINER Pritish Chakraborty
</span><span class='line'>
</span><span class='line'><span class="c"># Copy custom configuration file from the current directory</span>
</span><span class='line'>COPY nginx.conf /etc/nginx/nginx.conf
</span><span class='line'>
</span><span class='line'><span class="c"># Uncomment the commented Dockerfile lines below when pushing to AWS</span>
</span><span class='line'><span class="c"># COPY container_ip.sh /root/container_ip.sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Get django container&#39;s IP and put it in nginx.conf</span>
</span><span class='line'><span class="c"># RUN /root/container_ip.sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Reload the damn nginx service</span>
</span><span class='line'><span class="c"># CMD [&quot;service&quot;, &quot;nginx&quot;, &quot;restart&quot;]</span>
</span><span class='line'>CMD /usr/sbin/nginx -g <span class="s2">&quot;daemon off;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not much to explain here until I get to the part about deploying to AWS. Here&rsquo;s nginx.conf -:</p>

<figure class='code'><figcaption><span>nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>worker_processes 1<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections 1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    server <span class="o">{</span>
</span><span class='line'>        listen 80<span class="p">;</span>
</span><span class='line'>        server_name example.org<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        access_log /dev/stdout<span class="p">;</span>
</span><span class='line'>        error_log /dev/stdout info<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        location /static/ <span class="o">{</span>
</span><span class='line'>            <span class="nb">alias</span> /usr/src/app/repo/static<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location /static/javascripts/ <span class="o">{</span>
</span><span class='line'>          default_type text/javascript<span class="p">;</span>
</span><span class='line'>          <span class="nb">alias</span> /usr/src/app/repo/static/javascripts/<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location /static/stylesheets/ <span class="o">{</span>
</span><span class='line'>          default_type text/css<span class="p">;</span>
</span><span class='line'>          <span class="nb">alias</span> /usr/src/app/repo/static/stylesheets/<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /static/bower_components/ <span class="o">{</span>
</span><span class='line'>    types <span class="o">{</span>
</span><span class='line'>      text/css css<span class="p">;</span>
</span><span class='line'>      text/javascript js<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="nb">alias</span> /usr/src/app/repo/static/bower_components/<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /static/partials/ <span class="o">{</span>
</span><span class='line'>    types <span class="o">{</span>
</span><span class='line'>      text/html html<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="nb">alias</span> /usr/src/app/repo/static/partials/<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /static/admin/ <span class="o">{</span>
</span><span class='line'>          <span class="nb">alias</span> /usr/src/app/repo/static/admin/<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /static/admin/css <span class="o">{</span>
</span><span class='line'>    default_type text/css<span class="p">;</span>
</span><span class='line'>    <span class="nb">alias</span> /usr/src/app/repo/static/admin/css<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /static/admin/js <span class="o">{</span>
</span><span class='line'>    default_type text/javascript<span class="p">;</span>
</span><span class='line'>    <span class="nb">alias</span> /usr/src/app/repo/static/admin/js<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  location /static/admin/img <span class="o">{</span>
</span><span class='line'>    types <span class="o">{</span>
</span><span class='line'>      image/png png<span class="p">;</span>
</span><span class='line'>      image/jpeg jpg<span class="p">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="nb">alias</span> /usr/src/app/repo/static/admin/img<span class="p">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location / <span class="o">{</span>
</span><span class='line'>            proxy_pass http://django:8000<span class="p">;</span>
</span><span class='line'>            proxy_set_header   Host <span class="nv">$host</span><span class="p">;</span>
</span><span class='line'>            proxy_set_header   X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>            proxy_set_header   X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>            proxy_set_header   X-Forwarded-Host <span class="nv">$server_name</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, I had to make it very thorough about what files nginx was going to serve,
from where, and what type mappings would the files have had. The latter had me stumped for
a bit - I got nginx to serve all static files, but it was as if the browser didn&rsquo;t know
what to do with them, so take note. Finally, the location directive tells nginx whom
to proxy pass (django container service). There will be a minor change to this bit later
when we deploy on AWS.</p>

<p>The second part of this post will deal with the actual commands needed to deploy the setup;
first, on my local machine (virtualbox driver), and then on AWS. I&rsquo;ll add a bonus command
to deploy to DigitalOcean for shits and giggles.
Coming soon!</p>

<div id="discourse-comments"></div>


<script type="text/javascript">
  var discourseUrl = "",
      discourseEmbedUrl = "http://PritishC.github.io/blog/2015/09/03/docker-is-awesome/";

  (function() {
    var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
      d.src = discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Pritish Chakraborty</span></span>

      








  


<time datetime="2015-09-03T21:56:16+05:30" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/angular/'>angular</a>, <a class='category' href='/blog/categories/aws/'>aws</a>, <a class='category' href='/blog/categories/devops/'>devops</a>, <a class='category' href='/blog/categories/django/'>django</a>, <a class='category' href='/blog/categories/docker/'>docker</a>, <a class='category' href='/blog/categories/nginx/'>nginx</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://PritishC.github.io/blog/2015/09/03/docker-is-awesome/" data-via="Crank7" data-counturl="http://PritishC.github.io/blog/2015/09/03/docker-is-awesome/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/03/08/analyzing-stuff-with-google-analytics/" title="Previous Post: Analyzing Stuff With Google Analytics">&laquo; Analyzing Stuff With Google Analytics</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/09/04/docker-is-awesome-part-ii/" title="Next Post: Docker Is Awesome - Part II">Docker Is Awesome - Part II &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  <section>
  <h1><a href="#">pritishc.com</a></h1>
  <p>Welcome to my website. <a href="https://google.com/+PritishChakraborty08">Pritish Chakraborty</a> here!</p>
  <p>To know more about me, check out my <a href="/about/">about</a> page. For stuff I work on, check out my GitHub page <a href="https://github.com/PritishC">here</a>.</p>
  <p>My (admittedly WIP) resume can be found <a href="https://www.dropbox.com/s/m2tq4fdb91k3628/pritish_cv.pdf?dl=0">here</a>.</p>
  <p>DISCLAIMER: Most of the stuff on this blog, other than stuff sourced from outside, is my personal opinion. If you don&#8217;t like what you see, you are free to browse to a different page!</p>
  <p>PS: Check out Instahyre if you&#8217;re looking for <a href="https://www.instahyre.com/jobs">startups jobs</a>!
  <div class="social-icons">
    

    

    
  <a href="https://google.com/+PritishChakraborty08"><img src="/images/social/googleplus.png" alt="Google+" /></a>


    
  <a href="https://github.com/PritishC"><img src="/images/social/github.png" alt="Github" /></a>


    
  <a href="https://twitter.com/Crank7"><img src="/images/social/twitter.png" alt="Twitter" /></a>


    <a href="/atom.xml"><img src="/images/social/rss.png" alt="RSS" /></a>
  </div>
</section>

  <section>
  <h1>Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/02/13/review-workaholics-vs-high-performers/">[Review] Workaholics vs High Performers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/06/uploading-with-django-and-amazon-s3/">Uploading With Django and Amazon S3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/04/docker-is-awesome-part-ii/">Docker Is Awesome - Part II</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/09/03/docker-is-awesome/">Docker Is Awesome - Part I</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/08/analyzing-stuff-with-google-analytics/">Analyzing Stuff With Google Analytics</a>
      </li>
    
  </ul>
</section>

  
    <section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/android'>android (1)</a></li><li><a href='/blog/categories/angular'>angular (1)</a></li><li><a href='/blog/categories/article-review'>article review (1)</a></li><li><a href='/blog/categories/aws'>aws (3)</a></li><li><a href='/blog/categories/devops'>devops (2)</a></li><li><a href='/blog/categories/django'>django (2)</a></li><li><a href='/blog/categories/docker'>docker (2)</a></li><li><a href='/blog/categories/electronics'>electronics (1)</a></li><li><a href='/blog/categories/general'>general (2)</a></li><li><a href='/blog/categories/github'>github (1)</a></li><li><a href='/blog/categories/google'>google (1)</a></li><li><a href='/blog/categories/kitkat'>kitkat (1)</a></li><li><a href='/blog/categories/linkedin'>linkedin (1)</a></li><li><a href='/blog/categories/nereid'>nereid (1)</a></li><li><a href='/blog/categories/nginx'>nginx (2)</a></li><li><a href='/blog/categories/openlabs'>openlabs (1)</a></li><li><a href='/blog/categories/postgresql'>postgresql (1)</a></li><li><a href='/blog/categories/tryton'>tryton (4)</a></li><li><a href='/blog/categories/virtualenv'>virtualenv (1)</a></li></ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/PritishC">@PritishC</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'PritishC',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Pritish Chakraborty -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

<p>
<span class="credit">Powered by <a href="http://octopress.org">Octopress</a> using the <a href="https://github.com/fapper/classic-martinb">classic-martinb</a> theme</span>
</p>
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'xpritish';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://PritishC.github.io/blog/2015/09/03/docker-is-awesome';
        var disqus_url = 'http://PritishC.github.io/blog/2015/09/03/docker-is-awesome';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
