<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Docker | Pritish Chakraborty]]></title>
  <link href="http://PritishC.github.io/blog/categories/docker/atom.xml" rel="self"/>
  <link href="http://PritishC.github.io/"/>
  <updated>2015-09-06T19:05:07+05:30</updated>
  <id>http://PritishC.github.io/</id>
  <author>
    <name><![CDATA[Pritish Chakraborty]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Docker Is Awesome - Part II]]></title>
    <link href="http://PritishC.github.io/blog/2015/09/04/docker-is-awesome-part-ii/"/>
    <updated>2015-09-04T22:56:15+05:30</updated>
    <id>http://PritishC.github.io/blog/2015/09/04/docker-is-awesome-part-ii</id>
    <content type="html"><![CDATA[This is Part 2 of the 'Docker Is Awesome' mini-series. You can catch Part 1
over [here](/blog/2015/09/03/docker-is-awesome/).

In this article, I'll explain how to use docker-machine, docker-compose and
docker-engine to deploy your setup on your local machine as well as to AWS.

<!--more-->

It is imperative to first understand what this trinity of tools does. docker-engine is the basic component - it is used to create, manipulate and delete
one-off containers. On the command line, one can invoke it by typing just
`docker`.

docker-compose is a tool built on top of docker-engine which allows us to
run multi-container systems. In our setup, we have three services - django,
postgres and nginx. Each runs in their own container, and compose lets us
coordinate them. The docker-compose reference urges us not to use it in
production *yet*, but it&#8217;s pretty good, so screw that!

docker-machine is a tool used to create and provision Docker hosts. This
provisioning can be done either on your local machine or on a cloud provider;
it supports quite a few of them, including AWS and DigitalOcean.

Here are the contents of the `rebuild_docker.sh` file -:

<figure class='code'><figcaption><span>rebuild_docker.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-compose build
</span><span class='line'>docker-compose up -d
</span><span class='line'>docker-compose ps
</span></code></pre></td></tr></table></div></figure>

The `build` option builds each service specified in the `docker-compose.yml` file.
The `up -d` option creates and starts the containers given in that list. Finally,
`ps` lets us see each running container, what command they&#8217;re running and what
their status is (exit codes if there were any errors).

With all that out of the way, let us begin!

## Local Machine Setup

Let&#8217;s create a docker-machine host for our local machine. We will be using the Virtualbox
driver to get that running.

<figure class='code'><figcaption><span>docker-machine local</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-machine create -d virtulabox dev<span class="p">;</span>
</span><span class='line'>Creating VirtualBox VM...
</span><span class='line'>Creating SSH key...
</span><span class='line'>Starting VirtualBox VM...
</span><span class='line'>Starting VM...
</span><span class='line'>To see how to connect Docker to this machine, run: docker-machine env dev
</span></code></pre></td></tr></table></div></figure>

Well, since it tells us to -:

<figure class='code'><figcaption><span>docker-machine local</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-machine env dev
</span><span class='line'><span class="nb">export </span><span class="nv">DOCKER_TLS_VERIFY</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">DOCKER_HOST</span><span class="o">=</span><span class="s2">&quot;tcp://192.168.99.100:2376&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">DOCKER_CERT_PATH</span><span class="o">=</span><span class="s2">&quot;/home/pritishc/.docker/machine/machines/dev&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">DOCKER_MACHINE_NAME</span><span class="o">=</span><span class="s2">&quot;dev&quot;</span>
</span><span class='line'><span class="c"># Run this command to configure your shell: </span>
</span><span class='line'><span class="c"># eval &quot;$(docker-machine env dev)&quot;</span>
</span></code></pre></td></tr></table></div></figure>

A bunch of environment variables, hrm. Run the `eval` command as given to set those up.
Now we have a running docker host on our local. Check out the ip of the machine since
you will be needing that later -:

<figure class='code'><figcaption><span>docker-machine local</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-machine ip dev
</span><span class='line'>192.168.99.100
</span></code></pre></td></tr></table></div></figure>

Now we can run the contents of `rebuild_docker.sh` to build, create/start and list our
containers in one go. Note that the building process is initially quite slow; especially
on your local machine. The results of this build will be cached, making each subsequent
build much faster. However, **if you tinker with the Dockerfile of a service (like django),
the lines after the line you tinkered with will not be cached, and will be built again**.

Here&#8217;s what it looks like when the builds are cached -:

<figure class='code'><figcaption><span>docker-machine local cached build</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>postgres uses an image, skipping
</span><span class='line'>Building django...
</span><span class='line'>Step <span class="m">0</span> : FROM ubuntu:14.04
</span><span class='line'> ---&gt; 91e54dfb1179
</span><span class='line'>Step <span class="m">1</span> : ENV DJANGO_CONFIGURATION Docker
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 6c23847d177e
</span><span class='line'>Step <span class="m">2</span> : RUN apt-get update
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 37ceafd99c8b
</span><span class='line'>Step <span class="m">3</span> : RUN apt-get install -y ca-certificates git-core ssh nodejs npm python-pip libpq-dev python-dev
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; ca6793a2add5
</span><span class='line'>Step <span class="m">4</span> : RUN ln -s /usr/bin/nodejs /usr/bin/node
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; f9311c741b62
</span><span class='line'>Step <span class="m">5</span> : ENV HOME /root
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; b0f6dbd6a6fa
</span><span class='line'>Step <span class="m">6</span> : ADD ssh/ /root/.ssh/
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 1a50ee500dba
</span><span class='line'>Step <span class="m">7</span> : RUN chmod <span class="m">600</span> /root/.ssh/*
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 475bf637fea7
</span><span class='line'>Step <span class="m">8</span> : RUN ssh-keyscan bitbucket.org &gt; /root/.ssh/known_hosts
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 1bc79f8a33a0
</span><span class='line'>Step <span class="m">9</span> : WORKDIR /usr/src/app
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 6922edc704da
</span><span class='line'>Step <span class="m">10</span> : RUN git clone git@bitbucket.org:me/repo.git
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 29160d78c443
</span><span class='line'>Step <span class="m">11</span> : WORKDIR /usr/src/app/repo
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; ca03b1e414cc
</span><span class='line'>Step <span class="m">12</span> : RUN pip install -r requirements.txt
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 56fb3e85c03c
</span><span class='line'>Step <span class="m">13</span> : RUN npm install -g bower
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; e5660af6e528
</span><span class='line'>Step <span class="m">14</span> : RUN bower --allow-root install
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; d8b0d8cf33e6
</span><span class='line'>Step <span class="m">15</span> : ENV AWS_ACCESS_KEY youcanttouchthis
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 057f430aa52d
</span><span class='line'>Step <span class="m">16</span> : ENV AWS_SECRET_ACCESS_KEY secretsauce
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 68291ffdbd6c
</span><span class='line'>Step <span class="m">17</span> : ENV S3_BUCKET_NAME datbuckettho
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 2ba6884067d2
</span><span class='line'>Step <span class="m">18</span> : ENV DB_NAME postgres
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 951c81446ee1
</span><span class='line'>Step <span class="m">19</span> : ENV DB_USER postgres
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; b85ead2a75e3
</span><span class='line'>Step <span class="m">20</span> : ENV DB_PASS postgres
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 475c43341026
</span><span class='line'>Step <span class="m">21</span> : ENV DB_SERVICE postgres
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 4cc910cd2a51
</span><span class='line'>Step <span class="m">22</span> : ADD ./static/admin /usr/src/app/repo/static/admin
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; d70e3dd5c885
</span><span class='line'>Step <span class="m">23</span> : WORKDIR /usr/src/app/repo/project
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 255623db8059
</span><span class='line'>Step <span class="m">24</span> : CMD gunicorn project.wsgi -w <span class="m">2</span> -b 0.0.0.0:8000 --log-level -
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 55a7c489cb3e
</span><span class='line'>Successfully built 55a7c489cb3e
</span><span class='line'>Building nginx...
</span><span class='line'>Step <span class="m">0</span> : FROM nginx
</span><span class='line'> ---&gt; cd3cf76a61ee
</span><span class='line'>Step <span class="m">1</span> : MAINTAINER Pritish Chakraborty
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 73affa8810c3
</span><span class='line'>Step <span class="m">2</span> : COPY nginx.conf /etc/nginx/nginx.conf
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 3b73ef0ef3e8
</span><span class='line'>Step <span class="m">3</span> : COPY container_ip.sh /root/container_ip.sh
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; b3fbe36b0674
</span><span class='line'>Step <span class="m">4</span> : RUN /root/container_ip.sh
</span><span class='line'> ---&gt; Using cache
</span><span class='line'> ---&gt; 5df4fe6c5403
</span><span class='line'>Step <span class="m">5</span> : CMD service nginx restart
</span><span class='line'> ---&gt; Running in 642215ba03c6
</span><span class='line'> ---&gt; 4d2df9239cb3
</span><span class='line'>Removing intermediate container 642215ba03c6
</span><span class='line'>Step <span class="m">6</span> : CMD /usr/sbin/nginx -g <span class="s2">&quot;daemon off;&quot;</span>
</span><span class='line'> ---&gt; Running in 5bdc232c1761
</span><span class='line'> ---&gt; 2d55cf5df93b
</span><span class='line'>Removing intermediate container 5bdc232c1761
</span><span class='line'>Successfully built 2d55cf5df93b
</span><span class='line'>projectdocker_postgres_1 is up-to-date
</span><span class='line'>projectdocker_django_1 is up-to-date
</span><span class='line'>Recreating projectdocker_nginx_1...
</span><span class='line'>      Name             Command             State              Ports
</span><span class='line'>-------------------------------------------------------------------------
</span><span class='line'>projectdocker_dja   gunicorn           Up                 8000/tcp
</span><span class='line'>ngo_1              project.wsgi -w <span class="m">2</span>
</span><span class='line'>                   ...
</span><span class='line'>projectdocker_ngi   /bin/sh -c         Up                 443/tcp, 0.0.0.0
</span><span class='line'>nx_1               /usr/sbin/nginx                       :80-&gt;80/tcp
</span><span class='line'>                   ...
</span><span class='line'>projectdocker_pos   /docker-           Up                 5432/tcp
</span><span class='line'>tgres_1            entrypoint.sh
</span><span class='line'>                   postgres
</span></code></pre></td></tr></table></div></figure>

Pretty neat, huh? You can browse to the ip given by docker-machine in your
browser and check your website out in all its glory!

A couple more things - suppose some service breaks unexpectedly. You can
check out the logs using -:

<figure class='code'><figcaption><span>docker-compose logs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose logs &lt;servicename&gt;
</span></code></pre></td></tr></table></div></figure>

If you want to check out the contents of your container, run -:

<figure class='code'><figcaption><span>docker-compose run</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose run &lt;servicename&gt; bash
</span></code></pre></td></tr></table></div></figure>

## AWS Setup

This is it. The biggie. This is the part where you get to see your app running
on the cloud. We&#8217;re going to deploy our multi-container setup to Amazon EC2. But
first, we&#8217;re going to have to prepare a few things.

* Create a Virtual Private Cloud instance (VPC) which your EC2 instance will use.
This can be done from the VPC Management Console. If you signed up on the free-tier,
you might have a VPC instance running from the beginning. If not, create one!
Here&#8217;s what it looks like -:

<img src="/images/AWS_VPC.png" title="'AWS VPC'" >

<img src="/images/AWS_VPC_Subnets.png" title="'AWS VPC Subnets'" >

When creating a VPC, keep the tenancy as &#8216;default&#8217; and an example of a CIDR block
that you could choose is 172.31.0.0/16, where /16 is the subnet mask. Amazon does
the rest for you.

* With the VPC and its subnets (if there are none, create a public subnet) created,
we need to assign some security groups. First, according to Amazon&#8217;s [documentation](http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Scenario1.html),
make a security group (call it whatever you like) and add the rules as follows -:

<img src="/images/AWS_SG_1.png" title="'AWS Security Group Inbound Rules'" >

<img src="/images/AWS_SG_2.png" title="'AWS Security Group Outbound Rules'" >

In the inbound rules, IP ranges that I pixelized are my own. In these specific rules,
you&#8217;d select &#8216;My Own IP&#8217; when creating them. Finally, add the security group to your
VPC.

* With the VPC set up, go to the Identity Access Management console (IAM), and
generate a pair of credentials for docker-machine to use when setting up your EC2
box. I wasn&#8217;t able to figure out the security groups that this set of IAM credentials
should&#8217;ve had, so I gave it FullAdministratorAccess - this is usually not advisable.
Also note that the set of credentials which I put in my django Dockerfile are **not**
the same as these.

Now we can provision our docker host on AWS. Do it with this command -:

<figure class='code'><figcaption><span>docker-machine AWS</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker-machine create <span class="se">\ </span>
</span><span class='line'>--driver amazonec2 <span class="se">\</span>
</span><span class='line'>--amazonec2-access-key nicekeym8 <span class="se">\</span>
</span><span class='line'>--amazonec2-secret-key oososecret <span class="se">\</span>
</span><span class='line'>--amazonec2-vpc-id vpc-id <span class="se">\</span>
</span><span class='line'>--amazonec2-region some-region <span class="se">\</span>
</span><span class='line'>--amazonec2-zone zone-letter <span class="se">\</span>
</span><span class='line'>ec2box
</span></code></pre></td></tr></table></div></figure>

You can get the information from the VPC management console. This command takes a
while to execute, but when it is done, you&#8217;ll have to run the `eval` command like
we did for our local setup, to point docker-machine to our AWS host.

Once the machine is provisioned, go check it out on your EC2 management console -:

<img src="/images/AWS_EC2.png" title="'AWS EC2'" >

There&#8217;s still a bit of security group editing to do. Now when you check out your
VPC, you will find that it has a new group called `docker-machine`. Edit this group
and add the following inbound rule -:

<img src="/images/AWS_VPC_dockermachine.png" title="'docker-machine Rules'" >

Add this TCP rule for your own IP.

Now you can browse to the ip given by `docker-machine ip ec2box`/the one listed on
your EC2 instances page, and examine your webapp on the cloud at leisure!
Pat yourself on the back, you did it. Or not&#8230;

## What About Nginx?

Ah, so you *did* read my previous article carefully. If I&#8217;m right, you&#8217;ll find
that nginx is giving you weird errors (most likely a 502).

The last bit of trickery that I added to the nginx Dockerfile revolves around this
file - `container_ip.sh`. Its contents are as follows -:

<figure class='code'><figcaption><span>container_ip.sh</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># The awk command gets the IP for the django container from /etc/hosts</span>
</span><span class='line'><span class="c"># The sed command replaces the placeholder in nginx conf with this IP</span>
</span><span class='line'><span class="c"># Finally, the config placeholder is replaced with the IP</span>
</span><span class='line'><span class="nv">ip</span><span class="o">=</span><span class="sb">`</span>awk <span class="s1">&#39;/django/ {print $1; exit}&#39;</span> /etc/hosts<span class="sb">`</span><span class="p">;</span> sed -i <span class="s2">&quot;s//$ip/g&quot;</span> /etc/nginx/nginx.conf
</span></code></pre></td></tr></table></div></figure>

And the said placeholder is put in like this -:


<figure class='code'><figcaption><span>nginx config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>location / <span class="o">{</span>
</span><span class='line'>    proxy_pass http://<span class="o">{{</span>container_ip<span class="o">}}</span>:8000<span class="p">;</span>
</span><span class='line'>    proxy_set_header   Host <span class="nv">$host</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header   X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header   X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>    proxy_set_header   X-Forwarded-Host <span class="nv">$server_name</span><span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

`{{container_ip}}` is in place of &#8216;django&#8217;, which is replaced by the actual IP given in
the `/etc/hosts` file of the nginx container - you can confirm this for yourself by running
bash on the nginx container and running the awk and sed commands.

You might want to put `container_ip.sh` in the nginx directory so that docker can
find it when performing the ADD operation.

And now, run the following commands to recreate the nginx container -:

<figure class='code'><figcaption><span>nginx recreation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>docker-compose build --no-cache nginx
</span><span class='line'><span class="nv">$ </span>docker-compose up -d
</span></code></pre></td></tr></table></div></figure>

And there you have it. Give it a bit of time for AWS to iron everything out, and with
luck, you&#8217;ll be able to play with your webapp on the cloud.

Hope you enjoyed this article :) I&#8217;ll write another one soon for that django-storages +
Amazon S3 setup of mine.

<div id="discourse-comments"></div>
<script type="text/javascript">
  var discourseUrl = "http://discourse.pritishc.com/",
      discourseEmbedUrl = "http://PritishC.github.io/blog/2015/09/04/docker-is-awesome-part-ii/";

  (function() {
    var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
      d.src = discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Docker Is Awesome - Part I]]></title>
    <link href="http://PritishC.github.io/blog/2015/09/03/docker-is-awesome/"/>
    <updated>2015-09-03T21:56:16+05:30</updated>
    <id>http://PritishC.github.io/blog/2015/09/03/docker-is-awesome</id>
    <content type="html"><![CDATA[It's been a while since I've written a blog post. There's been lots of changes that I've
had to deal with, the big one being a change of workplace. And I realize that this post
should've been the one explaining my adventures with Elasticsearch. That will have to wait
for a bit, my apologies!

In this article, I'm going to explain my (possibly flawed) method of deploying a Django/Angular
app using Docker. I've wanted to learn how to deploy an app to AWS for a while, and Docker
helped me do just that.

<!--more-->

I assume that the reader has a basic knowledge of the docker toolbox; if not, I&#8217;ll explain them in brief in
part 2. To begin with, here&#8217;s the directory structure of my app for reference (generated using the
lovely `tree` command on Linux) -:

<figure class='code'><figcaption><span>app structure</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">|</span>-- bower.json
</span><span class='line'><span class="p">|</span>-- CONTRIBUTORS
</span><span class='line'><span class="p">|</span>-- project
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- project
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- aws_settings.py <span class="o">(</span>django-storages credentials here<span class="o">)</span>
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- heroku_settings.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- __init__.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- settings.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- urls.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- views.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- wsgi.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- manage.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- app1
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- __init__.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- permissions.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- serializers.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- services.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- tests.py
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- views.py
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- users
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- __init__.py
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- models.py
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- permissions.py
</span><span class='line'><span class="p">|</span>       <span class="p">|</span>-- serializers.py
</span><span class='line'><span class="p">|</span>       <span class="sb">`</span>-- views.py
</span><span class='line'><span class="p">|</span>-- gulpfile.js
</span><span class='line'><span class="p">|</span>-- package.json
</span><span class='line'><span class="p">|</span>-- Procfile
</span><span class='line'><span class="p">|</span>-- README.md
</span><span class='line'><span class="p">|</span>-- requirements.txt
</span><span class='line'><span class="p">|</span>-- scripts
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- postInstall.sh
</span><span class='line'><span class="p">|</span>-- static
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- javascripts
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- app.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- controllers
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- controllers.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>-- directives
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- directives.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>   <span class="sb">`</span>-- services
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>       <span class="sb">`</span>-- services.js
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- partials <span class="o">(</span>angular view stuff<span class="o">)</span>
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- stylesheets
</span><span class='line'><span class="p">|</span>       <span class="sb">`</span>-- styles.css
</span><span class='line'><span class="p">|</span>-- templates
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- index.html
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- javascripts.html
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- navbar.html
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- stylesheets.html
</span></code></pre></td></tr></table></div></figure>

This follows from the nice boilerplate provided by [thinkster.io](https://github.com/brwr/thinkster-django-angular-boilerplate) - take a look at their nifty tutorials [here](http://thinkster.io).

I first stumbled across this article on [realpython.com](https://realpython.com/blog/python/django-development-with-docker-compose-and-machine/), which greatly piqued my interest. I realized that docker had
moved on to becoming a suite of tools - docker itself becoming docker-engine in name. However,
I faced issues (being a total n00b in devops) in setting up with the configuration that they
specified, so I decided to go for something simpler. I found just what I needed in [Andre&#8217;s](https://github.com/andrecp/django-tutorial-docker-nginx-postgres)
tutorial for deploying a simple Docker-Nginx-Django-Postgres setup.

One thing I noticed in both configurations is that the code repository was bundled alongwith the docker
stuff (needed by docker-compose) for production.
I couldn&#8217;t agree with that, so I decided to look up a method to clone my repository while creating
the docker container. I then kept my code and deployment repositories separate, and found that Bitbucket
(where my repositories are hosted) have a feature called deployment keys - SSH keys that have read-only
access to a repository. This was exactly what I needed.

Here is the directory structure of my docker deployment repository -:

<figure class='code'><figcaption><span>docker directories</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="p">|</span>-- docker-compose.yml
</span><span class='line'><span class="p">|</span>-- Dockerfile
</span><span class='line'><span class="p">|</span>-- ec2box.sh
</span><span class='line'><span class="p">|</span>-- nginx
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- container_ip.sh
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- Dockerfile
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- nginx.conf
</span><span class='line'><span class="p">|</span>-- README.md
</span><span class='line'><span class="p">|</span>-- rebuild_docker.sh
</span><span class='line'><span class="p">|</span>-- ssh
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- bb_deploy.rsa
</span><span class='line'><span class="p">|</span>   <span class="p">|</span>-- bb_deploy.rsa.pub
</span><span class='line'><span class="p">|</span>   <span class="sb">`</span>-- config
</span><span class='line'><span class="sb">`</span>-- static
</span><span class='line'>    <span class="sb">`</span>-- admin
</span></code></pre></td></tr></table></div></figure>

* docker-compose.yml : The file that controls how docker-compose builds docker containers and runs them
* Dockerfile : The Dockerfile for the django/angular container
* ec2box.sh : A small script containing a single command which creates the whole setup using AWS drivers
* nginx - Directory containing specifics for the nginx container, where container_ip.sh is another
small script which I needed when deploying on AWS
* rebuild_docker.sh : A script from Andre&#8217;s repository for quickly build-and-up containers using docker-compose
* ssh : Directory containing my Bitbucket deployment key and a SSH config file
* static : Django admin static files

The contents of docker-compose.yml are as follows -:

<figure class='code'><figcaption><span>docker-compose.yml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># Nginx</span>
</span><span class='line'><span class="l-Scalar-Plain">nginx</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">./nginx</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes_from</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">django</span>
</span><span class='line'>    <span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">django</span>
</span><span class='line'>    <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;80:80&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This defines a service for the Django app</span>
</span><span class='line'><span class="c1"># Will include the Angular frontend</span>
</span><span class='line'><span class="l-Scalar-Plain">django</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">.</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">.:/root</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/usr/src/app</span>
</span><span class='line'>    <span class="l-Scalar-Plain">expose</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="s">&quot;8000&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">postgres</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># This defines a service for the Postgres database</span>
</span><span class='line'><span class="l-Scalar-Plain">postgres</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres:latest</span>
</span></code></pre></td></tr></table></div></figure>

Note how the nginx container definition specifies a `volumes_from` section, of which the django
container is a part. The host port 80 has been mapped to container port 80, as nginx requires.
One little caveat: make sure that no other docker containers are hogging up port 80, because you
will have a painful time trying to find out why your nginx container keeps dying on you. The `links`
directive creates entries in the nginx container&#8217;s `/etc/hosts` file for the django container&#8217;s IP/hostname.
This will come in use later when we deploy to AWS.

The django container definition has a few small differences from the one mentioned at realpython or
Andre&#8217;s tutorial. We mount the volume on `/root` instead of `/usr/src/app`, because the latter does
not exist until we clone the code repository. Additionally, we expose `/usr/src/app` as a volume, so
that the nginx container does not run into a load of 404s when trying to serve static files. Port 8000
is exposed as we shall be running gunicorn on that port, and there is a link to the postgres container.

The postgres definition is not much to talk about, as it is built from an image from the docker registry
(yes, they have a registry of known docker containers!).


Let&#8217;s take a look at the Dockerfile for the django container -:

<figure class='code'><figcaption><span>Dockerfile (django)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>FROM ubuntu:14.04
</span><span class='line'>
</span><span class='line'>ENV DJANGO_CONFIGURATION Docker
</span><span class='line'>
</span><span class='line'><span class="c"># First, we need to get git, and clone our repository</span>
</span><span class='line'><span class="c"># Additionally, get everything else here too, such as nodejs and npm</span>
</span><span class='line'>
</span><span class='line'>RUN apt-get update
</span><span class='line'>RUN apt-get install -y ca-certificates git-core ssh nodejs npm python-pip libpq-dev python-dev
</span><span class='line'>RUN ln -s /usr/bin/nodejs /usr/bin/node
</span><span class='line'>
</span><span class='line'>ENV HOME /root
</span><span class='line'>
</span><span class='line'><span class="c"># Add custom ssh keypair - usually Bitbucket deployment keys</span>
</span><span class='line'>ADD ssh/ /root/.ssh/
</span><span class='line'>
</span><span class='line'><span class="c"># Fix permissions</span>
</span><span class='line'>RUN chmod <span class="m">600</span> /root/.ssh/*
</span><span class='line'>
</span><span class='line'><span class="c"># Avoid first connection host confirmation</span>
</span><span class='line'>RUN ssh-keyscan bitbucket.org &gt; /root/.ssh/known_hosts
</span><span class='line'>
</span><span class='line'><span class="c"># Clone the repo</span>
</span><span class='line'>WORKDIR /usr/src/app
</span><span class='line'>RUN git clone git@bitbucket.org:username/repo
</span><span class='line'>
</span><span class='line'><span class="c"># Install requirements</span>
</span><span class='line'>WORKDIR /usr/src/app/repo
</span><span class='line'>RUN pip install -r requirements.txt
</span><span class='line'>RUN npm install -g bower
</span><span class='line'>RUN bower --allow-root install
</span><span class='line'>
</span><span class='line'><span class="c"># S3 Storage for django-storages</span>
</span><span class='line'>ENV AWS_ACCESS_KEY yourkeyhere
</span><span class='line'>ENV AWS_SECRET_ACCESS_KEY yoursecretsaucehere
</span><span class='line'>ENV S3_BUCKET_NAME yourbucketnamehere
</span><span class='line'>
</span><span class='line'><span class="c"># DB Settings</span>
</span><span class='line'>ENV DB_NAME postgres
</span><span class='line'>ENV DB_USER postgres
</span><span class='line'>ENV DB_PASS postgres
</span><span class='line'>ENV DB_SERVICE postgres
</span><span class='line'>
</span><span class='line'><span class="c"># Add Django Admin CSS</span>
</span><span class='line'>ADD ./static/admin /usr/src/app/repo/static/admin
</span><span class='line'>
</span><span class='line'>WORKDIR /usr/src/app/repo/defsec
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;gunicorn&quot;</span>, <span class="s2">&quot;app.wsgi&quot;</span>, <span class="s2">&quot;-w&quot;</span>, <span class="s2">&quot;2&quot;</span>, <span class="s2">&quot;-b&quot;</span>, <span class="s2">&quot;0.0.0.0:8000&quot;</span>, <span class="s2">&quot;--log-level&quot;</span>, <span class="s2">&quot;-&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

The `DJANGO_CONFIGURATION` environment variable is used in django project settings. First, we
install all the necessary command line tools, and create a symbolic link so that nodejs plays
well. We then add our custom keypair to the `.ssh` directory, and run a permissions fix command.
This will allow us to clone the code repository. Before running the clone command, we run a
`ssh-keyscan` so that the cloning process is automatic - no key passphrase prompts. Some may argue
that this lowers security, but that is a topic for another post altogether.
After cloning, I install all django/angular requirements using pip and bower. A few more environment
variables are then set, first for django-storages (a topic for a soon-to-come post: how I set up
image uploads to Amazon S3 with django-storages) and then for the postgres database. Finally,
django admin static files are added (yes, these don&#8217;t come out of nowhere, they need to be added
for nginx to serve them) and run the gunicorn server.

With that covered, let&#8217;s check out the contents of the nginx directory. First up is the nginx
Dockerfile -:

<figure class='code'><figcaption><span>nginx Dockerfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># Set nginx base image</span>
</span><span class='line'>FROM nginx
</span><span class='line'>
</span><span class='line'><span class="c"># File Author / Maintainer</span>
</span><span class='line'>MAINTAINER Pritish Chakraborty
</span><span class='line'>
</span><span class='line'><span class="c"># Copy custom configuration file from the current directory</span>
</span><span class='line'>COPY nginx.conf /etc/nginx/nginx.conf
</span><span class='line'>
</span><span class='line'><span class="c"># Uncomment the commented Dockerfile lines below when pushing to AWS</span>
</span><span class='line'><span class="c"># COPY container_ip.sh /root/container_ip.sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Get django container&#39;s IP and put it in nginx.conf</span>
</span><span class='line'><span class="c"># RUN /root/container_ip.sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Reload the damn nginx service</span>
</span><span class='line'><span class="c"># CMD [&quot;service&quot;, &quot;nginx&quot;, &quot;restart&quot;]</span>
</span><span class='line'>CMD /usr/sbin/nginx -g <span class="s2">&quot;daemon off;&quot;</span>
</span></code></pre></td></tr></table></div></figure>

Not much to explain here until I get to the part about deploying to AWS. Here&#8217;s nginx.conf -:

<figure class='code'><figcaption><span>nginx.conf</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>worker_processes 1<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>    worker_connections 1024<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    server <span class="o">{</span>
</span><span class='line'>        listen 80<span class="p">;</span>
</span><span class='line'>        server_name example.org<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        access_log /dev/stdout<span class="p">;</span>
</span><span class='line'>        error_log /dev/stdout info<span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        location /static/ <span class="o">{</span>
</span><span class='line'>            <span class="nb">alias</span> /usr/src/app/repo/static<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location /static/javascripts/ <span class="o">{</span>
</span><span class='line'>          default_type text/javascript<span class="p">;</span>
</span><span class='line'>          <span class="nb">alias</span> /usr/src/app/repo/static/javascripts/<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location /static/stylesheets/ <span class="o">{</span>
</span><span class='line'>          default_type text/css<span class="p">;</span>
</span><span class='line'>          <span class="nb">alias</span> /usr/src/app/repo/static/stylesheets/<span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>	location /static/bower_components/ <span class="o">{</span>
</span><span class='line'>	  types <span class="o">{</span>
</span><span class='line'>	    text/css css<span class="p">;</span>
</span><span class='line'>	    text/javascript js<span class="p">;</span>
</span><span class='line'>	  <span class="o">}</span>
</span><span class='line'>	  <span class="nb">alias</span> /usr/src/app/repo/static/bower_components/<span class="p">;</span>
</span><span class='line'>	<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>	location /static/partials/ <span class="o">{</span>
</span><span class='line'>	  types <span class="o">{</span>
</span><span class='line'>	    text/html html<span class="p">;</span>
</span><span class='line'>	  <span class="o">}</span>
</span><span class='line'>	  <span class="nb">alias</span> /usr/src/app/repo/static/partials/<span class="p">;</span>
</span><span class='line'>	<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>	location /static/admin/ <span class="o">{</span>
</span><span class='line'>          <span class="nb">alias</span> /usr/src/app/repo/static/admin/<span class="p">;</span>
</span><span class='line'>	<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>	location /static/admin/css <span class="o">{</span>
</span><span class='line'>	  default_type text/css<span class="p">;</span>
</span><span class='line'>	  <span class="nb">alias</span> /usr/src/app/repo/static/admin/css<span class="p">;</span>
</span><span class='line'>	<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>	location /static/admin/js <span class="o">{</span>
</span><span class='line'>	  default_type text/javascript<span class="p">;</span>
</span><span class='line'>	  <span class="nb">alias</span> /usr/src/app/repo/static/admin/js<span class="p">;</span>
</span><span class='line'>	<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>	location /static/admin/img <span class="o">{</span>
</span><span class='line'>	  types <span class="o">{</span>
</span><span class='line'>	    image/png png<span class="p">;</span>
</span><span class='line'>	    image/jpeg jpg<span class="p">;</span>
</span><span class='line'>	  <span class="o">}</span>
</span><span class='line'>	  <span class="nb">alias</span> /usr/src/app/repo/static/admin/img<span class="p">;</span>
</span><span class='line'>	<span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        location / <span class="o">{</span>
</span><span class='line'>            proxy_pass http://django:8000<span class="p">;</span>
</span><span class='line'>            proxy_set_header   Host <span class="nv">$host</span><span class="p">;</span>
</span><span class='line'>            proxy_set_header   X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
</span><span class='line'>            proxy_set_header   X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span><span class='line'>            proxy_set_header   X-Forwarded-Host <span class="nv">$server_name</span><span class="p">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

As you can see, I had to make it very thorough about what files nginx was going to serve,
from where, and what type mappings would the files have had. The latter had me stumped for
a bit - I got nginx to serve all static files, but it was as if the browser didn&#8217;t know
what to do with them, so take note. Finally, the location directive tells nginx whom
to proxy pass (django container service). There will be a minor change to this bit later
when we deploy on AWS.

The second part of this post will deal with the actual commands needed to deploy the setup;
first, on my local machine (virtualbox driver), and then on AWS. I&#8217;ll add a bonus command
to deploy to DigitalOcean for shits and giggles.
Coming soon!

<div id="discourse-comments"></div>
<script type="text/javascript">
  var discourseUrl = "http://discourse.pritishc.com/",
      discourseEmbedUrl = "http://PritishC.github.io/blog/2015/09/03/docker-is-awesome/";

  (function() {
    var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
      d.src = discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>
]]></content>
  </entry>
  
</feed>
